/*
The MIT License (MIT)

Copyright (c) 2018 Wolfgang Hoenig and James Alan Preiss

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.
*/

/*
Geometric tracking controller.
*/

#include <math.h>

#include "param.h"
#include "log.h"
#include "math3d.h"
#include "stabilizer.h"
#include "physicalConstants.h"
#include "controller_geom.h"
#include "controller_flip.h"


// Inertia matrix components
static float Ixx = 0.000014;
static float Izz = 0.0000217;

static float t = 0;
static float dt = (float)(1.0f/ATTITUDE_RATE);

const static float thrust_scale = 132000; // 119460.0; TODO: find a solution (scale gains somehow)
const static float rollpitch_scale = 7345302.2678;
const static float yaw_scale = 4759362.5498;

static float kr_xy = 0.4;
static float kr_z = 1.25;
static float kv_xy = 0.2;
static float kv_z = 0.4;
static float kR_xy = 0.0095; // 70000/rollpitch_scale;
static float kR_z = 0.0126; // 60000/yaw_scale
static float kw_xy = 0.0027; // 20000/rollpitch_scale;
static float kw_z = 0.0025; // 12000/yaw_scale
static float kd_omega_rp = 0.000027; // 200/rollpitch_scale

// Logging variables

static float cmd_thrust_g;
static float cmd_roll;
static float cmd_pitch;
static float cmd_yaw;
static float r_roll;
static float r_pitch;
static float r_yaw;

static float q0;
static float q2;
static struct quat q;
static float timescale = 1;
static struct vec eR, ew, wd;
static float p_des, p;

static float prev_omega_roll;
static float prev_omega_pitch;
static float prev_setpoint_omega_roll;
static float prev_setpoint_omega_pitch;
static float err_d_roll = 0;
static float err_d_pitch = 0;

static bool mode = false;  // 0: position control, 1: attitude control
static float thrust_tmp;

static float g_vehicleMass = 0.027;

static float psi = 0;

static bool gp = false;
static float u0 = 0;
static float u1 = 0;
static float gr0[5] = {-0.0350, -0.0175,  0.0000,  0.0175,  0.0350};
static float gr1[9] = {-1.0000, -0.8725, -0.7450, -0.6175, -0.4900, -0.3625, -0.2350, -0.1075, 0.0200};
static float gr2[5] = {-0.1000, -0.0500,  0.0000,  0.0500,  0.1000};
static float gr3[9] = {-0.1000,  0.2000,  0.5000,  0.8000,  1.1000,  1.4000,  1.7000,  2.0000, 2.3000};
static int min0_i = 0, min1_i = 0, min2_i = 0, min3_i = 0;

/*static float u2 = 0;
static float sf1 = 0.135f;
static float sf2 = 0.477f;
static float X[48][4] = {{0.000,-0.002,-0.002,-0.003},
{0.000,-0.002,0.013,0.040},
{0.003,-0.012,0.043,0.142},
{0.010,-0.035,0.036,0.171},
{0.014,-0.060,0.009,0.164},
{0.016,-0.085,0.007,0.183},
{0.017,-0.115,0.011,0.251},
{0.018,-0.156,0.008,0.341},
{0.019,-0.211,0.007,0.465},
{0.018,-0.317,-0.058,0.737},
{0.011,-0.428,-0.042,0.937},
{0.009,-0.559,-0.015,1.191},
{0.009,-0.707,-0.023,1.496},
{0.009,-0.854,-0.057,1.852},
{0.012,-0.970,-0.056,2.125},
{0.016,-0.997,-0.013,2.144},
{0.020,-0.925,0.018,1.968},
{0.022,-0.782,0.010,1.680},
{0.025,-0.614,-0.003,1.402},
{0.028,-0.446,-0.009,1.156},
{0.028,-0.298,0.062,0.881},
{0.016,-0.182,0.105,0.581},
{0.009,-0.108,-0.074,0.298},
{0.018,-0.077,0.002,0.038},
{0.000,-0.000,0.000,0.001},
{0.001,-0.002,0.017,0.039},
{0.006,-0.014,0.053,0.134},
{0.016,-0.043,0.029,0.149},
{0.019,-0.065,0.023,0.150},
{0.022,-0.091,0.027,0.203},
{0.026,-0.127,0.025,0.272},
{0.028,-0.172,0.010,0.352},
{0.028,-0.234,0.003,0.490},
{0.024,-0.321,-0.074,0.747},
{0.014,-0.437,-0.050,0.916},
{0.012,-0.568,0.001,1.135},
{0.013,-0.666,-0.007,1.473},
{0.011,-0.865,-0.024,1.818},
{0.010,-0.974,-0.013,2.103},
{0.010,-0.996,0.018,2.150},
{0.007,-0.920,0.018,2.000},
{0.006,-0.829,0.006,1.706},
{0.004,-0.610,-0.005,1.406},
{0.002,-0.446,-0.005,1.185},
{-0.003,-0.295,0.038,0.990},
{-0.007,-0.157,-0.007,0.832},
{-0.009,-0.084,0.058,0.431},
{-0.023,-0.030,0.073,-0.027}};
static float alpha1[48] = {-1248.766,459.255,44.214,-34.284,127.946,-216.751,-2.501,121.021,-55.371,1.990,1.424,-9.429,-8.707,2.210,-1.681,2.783,-3.673,0.432,-1.284,2.732,-2.483,-1.006,4.522,27.951,1387.830,-645.825,17.690,14.348,39.608,-64.078,32.931,-17.654,7.302,3.362,-1.635,4.712,5.039,4.531,-2.717,-2.625,3.136,-2.654,6.305,3.962,-4.778,2.602,-6.563,-2.166};
static float alpha2[48] = {-106.574,176.405,-227.534,330.329,-243.287,289.092,-259.870,220.247,-88.794,17.381,1.528,2.153,5.764,-5.659,6.487,-1.496,-0.003,-0.692,-2.744,0.853,-2.063,-0.351,-4.260,11.433,-73.246,108.075,3.004,-354.976,362.757,-250.661,161.215,-106.161,45.830,-10.685,-5.976,4.136,-2.143,6.399,-21.441,10.587,7.035,-3.006,-1.563,-6.298,3.222,-4.217,7.658,0.271};
static float lam1[4] = {16119.646,11.104,222.851,9.934};
static float lam2[4] = {7222.721,1.805,54.594,13.825};*/

static int ltb1[2025] = {25073,25030,24053,22343,19586,14941,7663,-1892,-11798,25063,25020,24047,22343,19591,14951,7675,-1881,-11788,25051,25011,24042,22342,19596,14960,7687,-1869,-11778,25040,25001,24035,22341,19600,14968,7698,-1857,-11767,25027,24990,24028,22339,19604,14976,7709,-1845,-11757,26011,24787,22500,19401,15324,9727,2174,-6880,-15708,25997,24775,22492,19399,15328,9735,2186,-6868,-15698,25983,24763,22483,19396,15331,9744,2197,-6856,-15687,25968,24750,22475,19393,15334,9752,2209,-6844,-15676,25953,24736,22465,19390,15337,9760,2220,-6832,-15665,25946,23448,19932,15643,10466,4109,-3536,-11879,-19394,25929,23433,19922,15638,10468,4116,-3525,-11868,-19384,25911,23417,19911,15633,10470,4124,-3514,-11857,-19374,25894,23402,19900,15628,10472,4131,-3504,-11844,-19363,25876,23385,19887,15623,10473,4138,-3493,-11833,-19352,24811,21028,16490,11363,5466,-1346,-8880,-16374,-22477,24791,21010,16477,11356,5466,-1340,-8871,-16364,-22468,24770,20992,16463,11349,5467,-1334,-8861,-16353,-22459,24750,20973,16448,11343,5467,-1327,-8850,-16342,-22448,24728,20953,16434,11335,5466,-1322,-8841,-16330,-22438,22659,17662,12400,6901,776,-6107,-13314,-19898,-24628,22636,17642,12384,6892,774,-6102,-13306,-19888,-24619,22613,17621,12368,6884,773,-6098,-13297,-19879,-24610,22589,17599,12351,6874,771,-6093,-13289,-19868,-24601,22565,17577,12335,6865,770,-6088,-13279,-19858,-24591,19664,13600,7961,2594,-3222,-9758,-16430,-22108,-25620,19639,13577,7942,2584,-3226,-9755,-16423,-22100,-25612,19614,13553,7924,2573,-3229,-9752,-16416,-22091,-25604,19588,13529,7906,2562,-3232,-9749,-16409,-22082,-25596,19562,13505,7887,2551,-3235,-9745,-16401,-22072,-25587,16103,9172,3503,-1261,-6270,-12061,-18016,-22844,-25370,16076,9147,3483,-1272,-6275,-12060,-18010,-22837,-25364,16049,9123,3463,-1285,-6279,-12059,-18005,-22830,-25357,16023,9098,3444,-1297,-6284,-12056,-17998,-22822,-25349,15994,9071,3424,-1309,-6288,-12054,-17992,-22814,-25341,12313,4757,-642,-4439,-8249,-12977,-18076,-22142,-23949,12286,4731,-663,-4453,-8254,-12977,-18072,-22137,-23943,12258,4706,-683,-4465,-8260,-12976,-18068,-22131,-23938,12230,4680,-703,-4478,-8266,-12975,-18063,-22124,-23931,12202,4654,-724,-4491,-8271,-12974,-18058,-22117,-23924,8641,722,-4189,-6805,-9183,-12648,-16812,-20216,-21560,8613,696,-4210,-6818,-9190,-12648,-16809,-20212,-21555,8587,670,-4231,-6832,-9196,-12649,-16806,-20207,-21551,8559,646,-4251,-6844,-9202,-12649,-16802,-20201,-21545,8531,619,-4271,-6858,-9207,-12649,-16798,-20196,-21540,24869,24966,24216,22769,20242,15728,8450,-1227,-11326,24858,24957,24210,22768,20247,15738,8462,-1215,-11316,24846,24948,24204,22768,20251,15747,8474,-1203,-11306,24834,24938,24198,22766,20255,15755,8485,-1191,-11295,24822,24927,24191,22764,20258,15764,8496,-1179,-11285,25660,24588,22558,19765,15960,10526,2989,-6182,-15207,25646,24576,22550,19763,15963,10534,3001,-6170,-15197,25632,24563,22541,19760,15967,10542,3012,-6158,-15186,25617,24550,22532,19757,15970,10551,3024,-6146,-15176,25602,24536,22523,19753,15972,10559,3035,-6134,-15164,25415,23074,19846,15907,11047,4889,-2718,-11169,-18878,25397,23059,19835,15902,11049,4896,-2708,-11158,-18868,25380,23043,19824,15897,11051,4903,-2697,-11146,-18858,25362,23027,19813,15892,11053,4910,-2686,-11134,-18847,25343,23011,19801,15887,11054,4918,-2675,-11122,-18836,24070,20447,16224,11492,5960,-616,-8086,-15672,-21961,24050,20428,16210,11485,5959,-610,-8076,-15662,-21951,24029,20410,16196,11478,5960,-604,-8066,-15651,-21942,24008,20391,16182,11471,5960,-598,-8056,-15639,-21931,23987,20371,16168,11464,5960,-591,-8046,-15628,-21920,21691,16851,11929,6867,1152,-5454,-12568,-19223,-24125,21668,16830,11913,6858,1150,-5450,-12560,-19214,-24116,21645,16809,11896,6849,1149,-5445,-12551,-19204,-24107,21621,16787,11880,6839,1147,-5440,-12542,-19193,-24097,21597,16765,11863,6830,1146,-5435,-12534,-19183,-24087,18467,12551,7270,2378,-2985,-9206,-15754,-21479,-25143,18441,12527,7251,2367,-2989,-9203,-15746,-21471,-25136,18415,12503,7233,2356,-2992,-9200,-15739,-21462,-25127,18389,12479,7214,2345,-2995,-9196,-15732,-21453,-25119,18363,12455,7196,2334,-2998,-9193,-15724,-21443,-25109,14689,7896,2597,-1663,-6184,-11624,-17425,-22274,-24930,14663,7870,2577,-1676,-6188,-11623,-17419,-22267,-24924,14635,7845,2556,-1688,-6193,-11621,-17413,-22260,-24917,14608,7819,2537,-1701,-6197,-11619,-17407,-22252,-24910,14580,7794,2517,-1713,-6202,-11617,-17401,-22244,-24901,10715,3282,-1743,-5019,-8312,-12662,-17579,-21641,-23554,10688,3256,-1764,-5033,-8319,-12662,-17575,-21636,-23548,10661,3230,-1785,-5045,-8324,-12662,-17571,-21630,-23543,10632,3204,-1805,-5059,-8330,-12661,-17566,-21623,-23536,10603,3178,-1827,-5072,-8335,-12660,-17561,-21616,-23529,6908,-905,-5448,-7536,-9385,-12453,-16413,-19789,-21215,6880,-931,-5469,-7550,-9392,-12453,-16410,-19784,-21210,6853,-957,-5490,-7564,-9398,-12454,-16407,-19780,-21205,6825,-984,-5510,-7577,-9404,-12454,-16403,-19774,-21200,6797,-1009,-5531,-7590,-9410,-12454,-16399,-19769,-21194,24588,24827,24304,23125,20836,16470,9216,-552,-10814,24577,24818,24299,23124,20841,16480,9228,-540,-10804,24566,24808,24293,23124,20846,16489,9240,-528,-10793,24554,24798,24286,23122,20850,16498,9251,-516,-10783,24542,24787,24279,23120,20854,16506,9263,-504,-10772,25231,24313,22545,20066,16546,11294,3799,-5460,-14654,25217,24301,22537,20064,16550,11302,3811,-5448,-14644,25203,24288,22529,20061,16553,11311,3822,-5436,-14634,25188,24275,22519,20058,16556,11319,3833,-5424,-14623,25172,24261,22510,20054,16559,11327,3845,-5412,-14612,24805,22629,19696,16119,11593,5653,-1890,-10420,-18300,24788,22613,19686,16114,11595,5661,-1879,-10408,-18289,24770,22597,19674,16110,11596,5668,-1868,-10397,-18279,24752,22581,19662,16105,11598,5676,-1857,-10385,-18268,24734,22564,19651,16099,11599,5683,-1846,-10373,-18258,23256,19801,15904,11582,6431,113,-7266,-14919,-21373,23235,19782,15891,11575,6431,119,-7256,-14908,-21363,23214,19764,15877,11568,6431,126,-7247,-14897,-21353,23193,19744,15862,11560,6431,132,-7237,-14886,-21343,23171,19724,15848,11553,6431,138,-7226,-14875,-21333,20655,15985,11415,6805,1519,-4788,-11785,-18488,-23545,20632,15963,11399,6796,1517,-4784,-11776,-18478,-23536,20609,15942,11381,6786,1515,-4780,-11768,-18469,-23527,20585,15920,11365,6777,1514,-4775,-11758,-18458,-23517,20560,15897,11348,6767,1512,-4770,-11750,-18448,-23507,17210,11458,6550,2146,-2747,-8631,-15031,-20784,-24587,17185,11434,6532,2135,-2751,-8627,-15024,-20776,-24580,17158,11410,6513,2124,-2754,-8624,-15017,-20767,-24571,17132,11386,6494,2112,-2757,-8621,-15009,-20758,-24563,17106,11362,6475,2101,-2760,-8618,-15002,-20748,-24554,13228,6589,1674,-2071,-6087,-11159,-16784,-21638,-24414,13200,6564,1654,-2083,-6091,-11158,-16779,-21631,-24407,13173,6537,1634,
-2097,-6097,-11156,-16772,-21623,-24400,13145,6512,1613,-2109,-6101,-11154,-16767,-21616,-24393,13117,6486,1593,-2122,-6106,-11152,-16760,-21607,-24385,9082,1790,-2849,-5593,-8361,-12317,-17034,-21077,-23088,9053,1763,-2870,-5607,-8367,-12317,-17030,-21071,-23082,9025,1738,-2891,-5621,-8373,-12316,-17026,-21065,-23076,8997,1711,-2912,-5634,-8379,-12316,-17021,-21059,-23070,8968,1684,-2933,-5648,-8385,-12315,-17016,-21052,-23063,5150,-2537,-6700,-8256,-9570,-12229,-15970,-19305,-20805,5122,-2563,-6722,-8269,-9576,-12230,-15967,-19300,-20801,5095,-2590,-6742,-8284,-9583,-12230,-15964,-19295,-20796,5066,-2616,-6763,-8298,-9589,-12230,-15960,-19290,-20791,5038,-2642,-6784,-8311,-9595,-12230,-15957,-19284,-20785,24235,24613,24318,23408,21365,17161,9955,126,-10265,24225,24604,24312,23408,21370,17171,9967,139,-10255,24213,24594,24306,23406,21375,17180,9978,151,-10244,24201,24584,24300,23405,21379,17188,9989,163,-10234,24189,24573,24292,23403,21382,17196,10001,174,-10223,24729,23965,22463,20304,17079,12025,4597,-4720,-14054,24714,23953,22455,20302,17082,12033,4607,-4708,-14044,24700,23940,22446,20299,17085,12041,4620,-4696,-14033,24685,23927,22437,20296,17089,12049,4631,-4684,-14023,24669,23913,22427,20292,17091,12058,4642,-4672,-14011,24124,22115,19485,16278,12098,6396,-1058,-9639,-17663,24107,22100,19474,16274,12100,6404,-1047,-9628,-17653,24089,22084,19463,16269,12101,6411,-1036,-9616,-17643,24071,22067,19451,16263,12103,6419,-1025,-9604,-17632,24052,22051,19438,16257,12104,6426,-1015,-9592,-17621,22374,19095,15535,11631,6876,838,-6428,-14121,-20719,22353,19077,15520,11624,6876,843,-6418,-14110,-20709,22332,19058,15506,11617,6876,850,-6408,-14100,-20700,22312,19039,15492,11609,6876,856,-6399,-14089,-20689,22289,19019,15477,11602,6875,862,-6388,-14077,-20679,19562,15071,10864,6717,1873,-4116,-10970,-17700,-22893,19539,15050,10847,6707,1871,-4111,-10962,-17690,-22884,19515,15028,10831,6698,1870,-4106,-10953,-17680,-22875,19491,15006,10814,6688,1868,-4102,-10945,-17670,-22866,19466,14983,10797,6679,1866,-4097,-10936,-17659,-22856,15906,10333,5807,1901,-2508,-8038,-14270,-20029,-23958,15880,10309,5789,1890,-2512,-8035,-14263,-20021,-23950,15854,10285,5770,1879,-2516,-8032,-14255,-20013,-23942,15827,10261,5751,1867,-2519,-8029,-14248,-20003,-23934,15801,10235,5732,1856,-2522,-8025,-14240,-19994,-23924,11732,5264,744,-2479,-5981,-10669,-16099,-20940,-23825,11704,5238,724,-2492,-5986,-10668,-16094,-20933,-23818,11676,5213,703,-2505,-5991,-10666,-16088,-20926,-23811,11649,5187,683,-2517,-5996,-10664,-16082,-20918,-23804,11620,5161,662,-2530,-6001,-10662,-16076,-20910,-23796,7426,296,-3947,-6158,-8394,-11944,-16446,-20454,-22554,7398,269,-3968,-6172,-8400,-11945,-16442,-20448,-22548,7370,243,-3990,-6186,-8406,-11944,-16438,-20442,-22542,7342,216,-4010,-6199,-8412,-11943,-16432,-20435,-22536,7312,189,-4032,-6213,-8418,-11942,-16427,-20429,-22529,3384,-4159,-7934,-8958,-9735,-11977,-15487,-18767,-20336,3356,-4185,-7955,-8971,-9741,-11979,-15485,-18763,-20332,3327,-4212,-7977,-8985,-9748,-11979,-15481,-18758,-20327,3299,-4238,-7998,-8999,-9755,-11979,-15478,-18753,-20322,3270,-4265,-8018,-9013,-9761,-11980,-15474,-18747,-20316,23813,24326,24256,23616,21823,17794,10658,804,-9685,23802,24317,24251,23616,21829,17803,10670,815,-9675,23790,24307,24245,23614,21833,17812,10682,827,-9664,23779,24297,24238,23613,21837,17821,10693,839,-9654,23766,24286,24231,23612,21840,17829,10704,851,-9644,24156,23547,22311,20475,17552,12712,5374,-3969,-13412,24142,23534,22303,20473,17556,12720,5385,-3957,-13402,24127,23522,22294,20470,17559,12729,5397,-3945,-13391,24112,23508,22285,20467,17562,12737,5408,-3933,-13381,24097,23495,22275,20463,17564,12745,5419,-3921,-13370,23377,21538,19214,16383,12558,7112,-230,-8834,-16975,23359,21523,19203,16378,12560,7119,-219,-8822,-16965,23342,21507,19192,16373,12562,7126,-208,-8811,-16955,23323,21491,19180,16368,12563,7133,-198,-8799,-16944,23305,21474,19167,16362,12565,7141,-187,-8787,-16933,21433,18338,15117,11640,7292,1549,-5579,-13287,-20005,21413,18319,15104,11632,7292,1555,-5570,-13276,-19995,21392,18300,15089,11625,7291,1561,-5560,-13265,-19986,21371,18281,15075,11617,7291,1567,-5550,-13254,-19976,21349,18261,15060,11610,7291,1573,-5540,-13243,-19965,18420,14119,10282,6602,2213,-3442,-10133,-16864,-22176,18397,14098,10265,6593,2211,-3437,-10124,-16855,-22167,18373,14076,10248,6584,2209,-3432,-10116,-16845,-22158,18349,14053,10231,6574,2207,-3427,-10107,-16835,-22149,18324,14031,10213,6564,2205,-3424,-10098,-16824,-22139,14568,9185,5050,1646,-2272,-7433,-13476,-19222,-23261,14541,9161,5031,1635,-2276,-7429,-13469,-19214,-23253,14515,9136,5012,1623,-2280,-7427,-13462,-19206,-23245,14489,9112,4993,1612,-2283,-7423,-13455,-19196,-23237,14462,9087,4974,1600,-2286,-7420,-13446,-19187,-23228,10214,3934,-185,-2883,-5867,-10159,-15378,-20187,-23169,10187,3908,-205,-2897,-5872,-10158,-15373,-20180,-23163,10159,3882,-225,-2909,-5877,-10156,-15367,-20173,-23155,10131,3856,-245,-2922,-5882,-10154,-15361,-20165,-23148,10103,3830,-267,-2935,-5887,-10153,-15355,-20158,-23140,5765,-1188,-5029,-6708,-8410,-11547,-15819,-19777,-21957,5737,-1214,-5051,-6721,-8416,-11548,-15815,-19772,-21951,5709,-1241,-5072,-6736,-8423,-11547,-15810,-19766,-21945,5680,-1268,-5094,-6749,-8429,-11547,-15806,-19759,-21939,5652,-1294,-5115,-6763,-8434,-11546,-15801,-19753,-21932,1624,-5755,-9137,-9633,-9878,-11702,-14969,-18183,-19811,1596,-5782,-9159,-9648,-9885,-11702,-14966,-18178,-19807,1566,-5808,-9181,-9663,-9892,-11703,-14963,-18173,-19802,1539,-5834,-9202,-9676,-9899,-11704,-14959,-18168,-19797,1510,-5861,-9223,-9690,-9905,-11704,-14956,-18163,-19792};
static int ltb0[2025] = {688,1788,-148,206,2369,1035,1660,1677,757,230,1057,-1189,-720,1814,381,965,2333,1590,-275,107,-2098,-1702,565,-799,-700,2059,2402,-556,-483,-2240,-1873,-246,-1474,-1787,958,2500,-500,-536,-1537,-1207,-356,-1254,-1531,-59,1643,796,2069,-169,193,2642,1119,1694,1683,754,265,1224,-1364,-876,2023,429,952,2318,1576,-313,134,-2404,-1995,625,-816,-783,2018,2374,-632,-537,-2564,-2182,-281,-1529,-1900,910,2466,-568,-599,-1757,-1406,-400,-1303,-1613,-87,1618,904,2353,-189,169,2894,1192,1700,1660,737,301,1393,-1537,-1040,2217,476,923,2263,1535,-350,165,-2706,-2294,679,-817,-855,1941,2305,-707,-586,-2883,-2493,-317,-1557,-1982,847,2389,-633,-658,-1974,-1607,-442,-1329,-1669,-114,1566,1010,2630,-207,136,3114,1251,1677,1608,708,336,1558,-1700,-1208,2386,520,879,2170,1469,-386,199,-2990,-2587,725,-800,-911,1833,2199,-776,-628,-3182,-2795,-351,-1557,-2028,770,2274,-694,-709,-2177,-1802,-480,-1332,-1695,-139,1488,1108,2889,-222,95,3292,1292,1625,1531,668,368,1713,-1846,-1373,2524,558,822,2044,1381,-417,233,-3246,-2863,760,-768,-948,1698,2061,-838,-661,-3451,-3077,-381,-1529,-2037,683,2126,-748,-751,-2358,-1983,-514,-1312,-1691,-159,1389,1195,3117,-233,46,3419,1314,1548,1432,619,396,1851,-1969,-1528,2622,590,754,1891,1276,-443,268,-3460,-3108,783,-721,-964,1543,1897,-889,-682,-3675,-3324,-407,-1474,-2007,592,1953,-792,-781,-2510,-2142,-540,-1269,-1656,-176,1274,1266,3306,-240,-6,3488,1316,1450,1317,564,419,1965,-2061,-1665,2676,613,680,1718,1157,-463,301,-3622,-3312,792,-661,-959,1376,1716,-927,-692,-3844,-3524,-428,-1396,-1941,500,1762,-824,-798,-2623,-2271,-559,-1206,-1592,-187,1148,1317,3445,-242,-61,3496,1297,1335,1189,505,435,2050,-2120,-1777,2684,626,602,1533,1032,-475,331,-3724,-3464,787,-593,-934,1204,1524,-949,-689,-3949,-3669,-441,-1298,-1843,410,1562,-842,-800,-2693,-2363,-568,-1125,-1503,-192,1016,1348,3528,-239,-115,3442,1259,1207,1056,444,445,2102,-2140,-1860,2644,629,523,1344,903,-479,356,-3761,-3557,768,-519,-890,1033,1330,-956,-673,-3985,-3750,-447,-1185,-1717,327,1360,-846,-789,-2716,-2415,-568,-1032,-1394,-191,883,1229,2144,610,-425,1406,952,718,632,469,841,1076,157,-522,1903,1247,656,732,1174,-239,-848,-893,-509,1890,1036,55,269,2031,-1264,-2230,-1699,-337,1297,290,-642,-461,2300,-1377,-2131,-1544,-129,510,-424,-750,-684,1585,1410,2462,673,-515,1528,1016,724,633,464,967,1243,137,-659,2050,1324,643,723,1157,-260,-934,-1061,-674,2017,1098,10,245,1997,-1423,-2491,-1960,-478,1377,315,-707,-491,2258,-1556,-2381,-1765,-209,543,-433,-809,-701,1555,1590,2779,730,-611,1632,1068,718,623,450,1091,1410,109,-808,2171,1383,618,702,1119,-277,-1010,-1233,-856,2116,1145,-36,217,1928,-1575,-2732,-2219,-636,1437,337,-762,-512,2178,-1726,-2614,-1980,-300,568,-433,-855,-706,1498,1761,3084,779,-708,1713,1105,700,603,429,1211,1574,74,-962,2259,1422,583,668,1064,-290,-1070,-1403,-1049,2181,1175,-81,185,1829,-1713,-2944,-2467,-807,1472,355,-803,-523,2063,-1883,-2820,-2182,-400,583,-425,-886,-699,1418,1917,3363,816,-803,1767,1124,671,573,402,1319,1726,32,-1116,2311,1438,538,625,993,-297,-1113,-1565,-1246,2209,1186,-123,152,1704,-1831,-3116,-2691,-984,1481,368,-828,-525,1920,-2018,-2988,-2360,-505,587,-409,-901,-680,1319,2050,3606,842,-892,1790,1126,631,535,370,1412,1861,-13,-1264,2323,1431,488,574,911,-299,-1135,-1710,-1437,2198,1179,-160,119,1559,-1923,-3240,-2881,-1158,1464,376,-836,-516,1755,-2125,-3110,-2508,-611,580,-385,-898,-650,1204,2155,3799,854,-969,1783,1110,584,490,335,1485,1973,-61,-1398,2295,1402,434,517,821,-296,-1135,-1831,-1614,2149,1153,-190,88,1402,-1984,-3309,-3029,-1323,1420,377,-827,-498,1575,-2198,-3180,-2616,-713,562,-355,-877,-610,1080,2225,3934,851,-1032,1745,1076,531,442,297,1534,2056,-109,-1510,2228,1350,378,458,726,-287,-1112,-1922,-1767,2064,1109,-211,60,1238,-2012,-3319,-3125,-1468,1353,373,-802,-472,1389,-2235,-3195,-2681,-805,535,-321,-841,-563,951,2258,4005,835,-1077,1678,1026,474,391,259,1557,2106,-154,-1597,2125,1280,322,398,631,-273,-1068,-1979,-1889,1948,1049,-224,35,1073,-2005,-3270,-3166,-1588,1265,362,-762,-438,1203,-2233,-3153,-2697,-882,499,-284,-791,-511,823,1576,1635,1759,-151,502,872,802,158,152,1565,696,1908,-62,831,1505,1425,50,420,341,-1507,698,29,749,1490,1479,-440,760,-1179,-3250,-948,17,117,466,685,-932,885,-1602,-3072,-1525,-63,-491,-670,-79,-682,659,1802,1855,1949,-172,529,906,814,162,148,1800,806,2099,-79,876,1555,1440,54,408,420,-1650,743,18,788,1529,1481,-443,735,-1307,-3594,-1084,7,123,465,657,-943,854,-1798,-3403,-1713,-72,-516,-708,-126,-694,635,2025,2069,2122,-193,548,925,812,163,142,2034,918,2268,-98,907,1579,1430,56,389,504,-1772,775,1,815,1544,1455,-438,699,-1423,-3903,-1217,-6,128,455,617,-938,808,-1983,-3702,-1890,-83,-532,-735,-172,-693,601,2236,2270,2270,-214,558,929,795,161,133,2257,1028,2408,-119,923,1577,1394,58,364,591,-1867,793,-21,829,1532,1404,-425,651,-1523,-4162,-1340,-26,132,439,565,-916,751,-2149,-3956,-2047,-96,-538,-749,-216,-681,557,2425,2448,2386,-233,559,917,765,156,123,2460,1133,2512,-142,923,1548,1335,58,334,678,-1929,797,-48,829,1495,1330,-405,596,-1600,-4359,-1448,-51,134,415,505,-879,685,-2288,-4153,-2178,-111,-535,-749,-254,-657,507,2584,2596,2464,-250,550,890,724,149,111,2634,1227,2574,-167,908,1495,1256,58,302,760,-1955,784,-79,816,1434,1237,-380,536,-1652,-4482,-1536,-80,133,386,440,-829,612,-2394,-4281,-2275,-128,-521,-735,-285,-622,453,2706,2706,2501,-264,531,850,672,140,99,2770,1307,2592,-190,878,1419,1160,56,267,833,-1942,757,
-113,788,1353,1128,-349,472,-1675,-4526,-1598,-112,132,354,372,-768,537,-2461,-4335,-2335,-145,-499,-708,-307,-579,397,2784,2774,2494,-274,504,798,613,129,86,2862,1369,2565,-213,834,1324,1052,53,232,895,-1891,717,-148,749,1255,1011,-316,408,-1669,-4487,-1633,-145,128,318,306,-699,463,-2486,-4311,-2353,-162,-469,-670,-320,-530,341,2813,2795,2445,-280,470,737,549,116,74,2904,1409,2493,-233,778,1215,938,50,198,942,-1804,665,-183,700,1144,888,-280,347,-1634,-4369,-1637,-178,122,282,243,-625,391,-2468,-4210,-2329,-178,-433,-622,-323,-477,287,1184,1072,1752,-109,-87,454,585,104,14,1563,951,2123,-322,-351,713,1102,70,20,1135,22,1204,-659,-905,472,1198,-221,0,183,-1010,-322,-886,-1446,-337,584,-566,-32,-405,-1246,-1049,-782,-1457,-983,-95,-456,-14,1353,1206,1939,-103,-100,464,594,107,12,1795,1093,2351,-320,-386,722,1115,77,15,1320,91,1339,-677,-975,461,1201,-216,-9,239,-1047,-347,-925,-1542,-381,564,-568,-45,-440,-1329,-1152,-823,-1547,-1041,-130,-463,-25,1519,1334,2108,-94,-112,466,593,109,11,2026,1237,2558,-311,-416,718,1107,81,11,1507,174,1463,-682,-1030,441,1182,-208,-18,301,-1058,-366,-948,-1616,-419,533,-561,-57,-468,-1388,-1243,-851,-1614,-1083,-164,-462,-36,1675,1452,2252,-81,-123,460,581,109,9,2245,1375,2735,-295,-439,702,1080,85,6,1690,270,1571,-674,-1069,412,1141,-196,-27,367,-1040,-378,-955,-1664,-451,492,-543,-68,-488,-1419,-1317,-865,-1654,-1107,-195,-453,-45,1816,1553,2363,-66,-131,446,559,107,8,2444,1503,2873,-271,-455,673,1035,86,2,1859,377,1659,-653,-1090,378,1082,-181,-34,434,-992,-382,-945,-1681,-474,444,-517,-76,-500,-1420,-1369,-865,-1664,-1110,-222,-436,-53,1933,1633,2437,-49,-138,425,528,103,6,2614,1615,2965,-242,-462,635,973,86,-1,2008,490,1722,-619,-1090,338,1007,-165,-39,500,-917,-376,-919,-1669,-488,391,-483,-82,-503,-1390,-1397,-850,-1646,-1094,-243,-412,-59,2022,1689,2469,-32,-141,398,490,97,5,2746,1706,3008,-209,-461,588,899,84,-4,2130,604,1757,-576,-1071,296,920,-147,-43,561,-816,-362,-878,-1628,-491,335,-444,-85,-496,-1329,-1399,-820,-1598,-1058,-258,-383,-62,2079,1717,2457,-14,-142,366,447,90,3,2834,1771,2998,-174,-451,535,816,81,-6,2218,713,1762,-525,-1033,253,825,-128,-45,614,-695,-340,-824,-1559,-483,280,-400,-85,-480,-1241,-1375,-779,-1525,-1006,-265,-350,-64,2099,1717,2403,2,-140,331,400,83,2,2872,1807,2936,-139,-433,478,727,75,-8,2268,812,1738,-469,-978,210,726,-110,-45,657,-559,-311,-759,-1466,-467,226,-355,-83,-455,-1130,-1326,-727,-1429,-939,-265,-314,-63,472,532,865,-52,-154,95,186,43,-5,826,884,1152,-230,-418,91,343,45,-26,965,1024,861,-506,-789,-94,352,-44,-70,731,785,196,-667,-1012,-398,127,-179,-105,345,374,-230,-560,-872,-538,-105,-185,-85,539,598,957,-46,-167,95,188,45,-5,946,1009,1280,-231,-450,85,345,47,-27,1108,1191,966,-525,-845,-112,349,-42,-72,843,936,234,-702,-1080,-428,117,-179,-108,400,462,-240,-592,-928,-569,-119,-187,-88,605,661,1040,-39,-178,93,187,45,-5,1065,1132,1396,-228,-476,78,341,49,-28,1250,1361,1065,-534,-889,-129,340,-39,-73,955,1093,274,-724,-1132,-451,104,-175,-109,456,557,-246,-616,-969,-591,-132,-186,-89,667,718,1110,-30,-186,89,183,45,-5,1177,1249,1497,-218,-494,69,331,50,-27,1386,1527,1154,-534,-919,-144,326,-35,-72,1062,1251,315,-735,-1165,-468,89,-169,-108,510,655,-245,-629,-996,-603,-143,-181,-89,722,766,1165,-20,-190,84,175,44,-5,1278,1354,1578,-204,-504,59,316,49,-27,1508,1682,1229,-522,-932,-156,305,-31,-70,1159,1403,355,-731,-1179,-476,73,-160,-105,560,753,-238,-631,-1004,-604,-150,-174,-86,768,804,1200,-9,-192,78,165,42,-5,1363,1442,1634,-185,-504,49,295,48,-25,1613,1820,1287,-501,-929,-164,281,-27,-67,1243,1543,392,-715,-1171,-475,57,-149,-100,604,847,-225,-623,-995,-595,-155,-164,-83,803,830,1216,2,-190,71,153,40,-5,1428,1510,1662,-163,-496,38,271,46,-24,1694,1933,1324,-471,-910,-169,253,-23,-63,1310,1665,425,-686,-1143,-465,41,-136,-94,639,931,-206,-603,-969,-575,-156,-152,-78,825,842,1209,13,-184,63,139,37,-4,1470,1554,1662,-139,-479,28,244,43,-22,1747,2017,1339,-434,-875,-170,224,-19,-57,1355,1762,451,-647,-1095,-448,26,-123,-86,663,1001,-183,-574,-927,-546,-154,-138,-72,832,840,1182,23,-176,55,124,33,-4,1486,1571,1633,-114,-454,19,216,40,-20,1770,2066,1331,-392,-827,-167,194,-15,-52,1376,1828,470,-598,-1032,-423,13,-108,-78,677,1055,-156,-536,-871,-510,-148,-123,-65};

void controllerGeomReset(void)
{
  t = 0;
}

void controllerGeomInit(void)
{
  controllerGeomReset();
}

bool controllerGeomTest(void)
{
  return true;
}

void controllerGeom(control_t *control, setpoint_t *setpoint,
                                         const sensorData_t *sensors,
                                         const state_t *state,
                                         const uint32_t tick)
{
  if (!RATE_DO_EXECUTE(ATTITUDE_RATE, tick)) {
      return;
    }

  struct vec er, ev, r1, r2, r3, M;
  struct mat33 Rd;
  float yaw_des = radians(setpoint->attitude.yaw);
  struct vec setpointPos = mkvec(setpoint->position.x, setpoint->position.y, setpoint->position.z);
  struct vec setpointVel = mkvec(setpoint->velocity.x, setpoint->velocity.y, setpoint->velocity.z);
  struct vec statePos = mkvec(state->position.x, state->position.y, state->position.z);
  struct vec stateVel = mkvec(state->velocity.x, state->velocity.y, state->velocity.z);
  float T;

  // Position Error (ep)
  er = vsub(statePos, setpointPos);

  // Velocity Error (ev)
  ev = vsub(stateVel, setpointVel);

  struct vec target_thrust = vzero();

  /* if (setpoint->mode.x == modeAbs) {
    target_thrust.x = -kr_xy*er.x - kv_xy*ev.x + g_vehicleMass*setpoint->acceleration.x;
    target_thrust.y = -kr_xy*er.y - kv_xy*ev.y + g_vehicleMass*setpoint->acceleration.y;
    target_thrust.z = -kr_z*er.z - kv_z*ev.z + g_vehicleMass*(setpoint->acceleration.x + GRAVITY_MAGNITUDE);
  } else {
    target_thrust.x = -sinf(radians(setpoint->attitude.pitch));
    target_thrust.y = -sinf(radians(setpoint->attitude.roll));
    if (setpoint->mode.z == modeAbs) {
      target_thrust.z = -kr_z*er.z - kv_z*ev.z + g_vehicleMass*GRAVITY_MAGNITUDE;
    } else {
      target_thrust.z = 1;
    }
  }*/
  
  if (!mode) {      // position control
    target_thrust.x = -kr_xy*er.x - kv_xy*ev.x + g_vehicleMass*setpoint->acceleration.x;
    target_thrust.y = -kr_xy*er.y - kv_xy*ev.y + g_vehicleMass*setpoint->acceleration.y;
    target_thrust.z = -kr_z*er.z - kv_z*ev.z + g_vehicleMass*(setpoint->acceleration.z + GRAVITY_MAGNITUDE);
    r3 = vnormalize(target_thrust);
    r2 = vnormalize(vcross(r3,mkvec(cosf(yaw_des), sinf(yaw_des), 0)));
    r1 = vcross(r2, r3);
    Rd = mcolumns(r1, r2, r3);
    wd = mkvec(radians(setpoint->attitudeRate.roll), -radians(setpoint->attitudeRate.pitch), radians(setpoint->attitudeRate.yaw));
  } else {
    target_thrust.z = -kr_z*er.z - kv_z*ev.z + g_vehicleMass*(setpoint->acceleration.z + GRAVITY_MAGNITUDE);
    t = getTime();
    T = t/timescale;
    // flip trajectory
    q0 = 1.998f/(1.0f+expf(-20.0f*(T-0.45f)))-0.999f;
    q2 = sqrtf(1.0f-q0*q0);
    float dq0 = -(39.9f * expf(-20.0f * (T - 0.45f))) / ( (expf(-20.0f * (T - 0.45f)) + 1.0f) * (expf(-20.0f * (T - 0.45f)) + 1.0f) );
    struct quat qd = mkquat(0, q2, 0, q0);
    struct vec eul_des = quat2rpy(qd);
    p_des = eul_des.y;
    Rd = quat2rotmat(qd);
    wd = mkvec(0.0f, -2.0f*dq0/sqrtf(1.0f-q0*q0), 0.0f);
  }
  q = mkquat(state->attitudeQuaternion.x, state->attitudeQuaternion.y, state->attitudeQuaternion.z, state->attitudeQuaternion.w);
  struct vec eul = quat2rpy(q);
  p = eul.y;
  struct mat33 R = quat2rotmat(q);

  struct mat33 eR1 = mmul(mtranspose(Rd),R);
  struct mat33 eR2 = mmul(mtranspose(R),Rd);
  struct mat33 tr_tmp = msub(meye(),eR1);
  psi = 0.5f*(tr_tmp.m[0][0] + tr_tmp.m[1][1] + tr_tmp.m[2][2]);

  struct mat33 eRm = msub(eR1,eR2);

  eR.x = 1.0f*eRm.m[2][1];
  eR.y = -1.0f*eRm.m[0][2];
  eR.z = 1.0f*eRm.m[1][0];

  float stateAttitudeRateRoll = radians(sensors->gyro.x);
  float stateAttitudeRatePitch = -radians(sensors->gyro.y);
  float stateAttitudeRateYaw = radians(sensors->gyro.z);

  struct vec w = mkvec(stateAttitudeRateRoll, stateAttitudeRatePitch, stateAttitudeRateYaw);

  // struct vec w_target = mvmul(eR2,wd);

  ew = vsub(w,wd);


  if (prev_omega_roll == prev_omega_roll) { /*d part initialized*/
    if (!mode){
      err_d_roll = ((radians(setpoint->attitudeRate.roll) - prev_setpoint_omega_roll) - (stateAttitudeRateRoll - prev_omega_roll)) / dt;
      err_d_pitch = (-(radians(setpoint->attitudeRate.pitch) - prev_setpoint_omega_pitch) - (stateAttitudeRatePitch - prev_omega_pitch)) / dt;
      prev_omega_roll = stateAttitudeRateRoll;
      prev_omega_pitch = stateAttitudeRatePitch;
      prev_setpoint_omega_roll = radians(setpoint->attitudeRate.roll);
      prev_setpoint_omega_pitch = radians(setpoint->attitudeRate.pitch);
    } else {
      err_d_roll = clamp(((wd.x - prev_setpoint_omega_roll) - (stateAttitudeRateRoll - prev_omega_roll)) / dt, -200, 200);
      err_d_pitch = clamp(((wd.y - prev_setpoint_omega_pitch) - (stateAttitudeRatePitch - prev_omega_pitch)) / dt, -200, 200);
      prev_omega_roll = stateAttitudeRateRoll;
      prev_omega_pitch = stateAttitudeRatePitch;
      prev_setpoint_omega_roll = wd.x;
      prev_setpoint_omega_pitch = wd.y;
    }
  }
  

  struct vec cross = vcross(w, mkvec(Ixx*w.x, Ixx*w.x, Izz*w.z));
  // cross = vzero();

  float thrust = 0;
  if (!mode){
    M.x = cross.x - kR_xy * eR.x - kw_xy * ew.x + kd_omega_rp * err_d_roll;
    M.y = cross.y - kR_xy * eR.y - kw_xy * ew.y + kd_omega_rp * err_d_pitch;
    M.z = -kR_z  * eR.z - kw_z  * ew.z;
    thrust = vdot(target_thrust, mcolumn(R,2));
  } else {
    /*float xtilde[4] = {q.x, q.y, w.x / 10.0f, w.y / 10.0f};
    float utmp = 0;

    float tmp1 = 0;
    float k1[48];
    for (int i = 0; i < 48; i++) {
      for (int j = 0; j < 4; j++) {
        tmp1 += -0.5f * lam1[j] * powf((xtilde[j] - X[i][j]), 2.0f);
      }
      k1[i] += sf1 * expf(tmp1);
    }
    for (int i = 0; i < 48; i++) {
      utmp += k1[i] * alpha1[i];
    }
    u1 = utmp / 200.0f;
    utmp = 0.0f;

    float tmp2 = 0;
    float k2[48];
    for (int i = 0; i < 48; i++) {
      for (int j = 0; j < 4; j++) {
        tmp2 += -0.5f * lam2[j] * powf((xtilde[j] - X[i][j]), 2.0f);
      }
      k2[i] += sf2 * expf(tmp2);
    }
    for (int i = 0; i < 48; i++) {
      utmp += k2[i] * alpha2[i];
    }
    u2 = utmp / 200.0f;
    */
    if(gp){
      float xtilde[4] = {q.x, q.y, w.x / 10.0f, w.y / 10.0f};
      float min0 = 10;
      float min1 = 10;
      float min2 = 10;
      float min3 = 10;
      min0_i = 0; min1_i = 0; min2_i = 0; min3_i = 0;
      for(int i=0; i < 5; i++){
        float diff = fabsf(gr0[i] - xtilde[0]);
        if(diff < min0) {
          min0 = diff;
          min0_i = i;
        }
      }
      for(int i=0; i < 9; i++){
        float diff = fabsf(gr1[i] - xtilde[1]);
        if(diff < min1) {
          min1 = diff;
          min1_i = i;
        }
      }
      for(int i=0; i < 5; i++){
        float diff = fabsf(gr2[i] - xtilde[2]);
        if(diff < min2) {
          min2 = diff;
          min2_i = i;
        }
      }
      for(int i=0; i < 9; i++){
        float diff = fabsf(gr3[i] - xtilde[3]);
        if(diff < min3) {
          min3 = diff;
          min3_i = i;
        }
      }
      u1 = (float)ltb1[min0_i*min1_i*min2_i*min3_i] / 10000.0f / 200.0f / 10.0f;
      u0 = (float)ltb0[min0_i*min1_i*min2_i*min3_i] / 10000.0f / 200.0f / 10.0f;
    }
    
    M.x = cross.x - kR_xy * eR.x - kw_xy * ew.x + kd_omega_rp * err_d_roll - u0;
    M.y = cross.y - kR_xy * eR.y - kw_xy * ew.y + kd_omega_rp * err_d_pitch - u1;
    M.z = kR_z  * eR.z - kw_z  * ew.z;
    float den = R.m[2][2];
    if(den > 1e-7f){
      thrust_tmp = clamp(target_thrust.z / den, 0.22f, 0.5f);
    } else{
      thrust_tmp = 0.22f;
    }
    //thrust = (0.22f * cosf(2.0f * 3.14f * t / (0.9f*timescale)) + 0.4f);
    thrust = thrust_tmp;
  }
  
 
  if (setpoint->mode.z == modeDisable) {
    control->thrust = setpoint->thrust;
  } else {
    control->thrust = thrust * thrust_scale;
  }
  cmd_thrust_g = thrust*thrust_scale;
  r_roll = radians(sensors->gyro.x);
  r_pitch = -radians(sensors->gyro.y);
  r_yaw = radians(sensors->gyro.z);

  if (control->thrust > 0) {
    control->roll = clamp(M.x * rollpitch_scale, -32000, 32000);
    control->pitch = clamp(M.y * rollpitch_scale, -32000, 32000);
    control->yaw = clamp(-M.z * yaw_scale, -32000, 32000);
    cmd_roll = control->roll;
    cmd_pitch = control->pitch;
    cmd_yaw = control->yaw;
  } else {
    control->roll = 0;
    control->pitch = 0;
    control->yaw = 0;

    cmd_roll = control->roll;
    cmd_pitch = control->pitch;
    cmd_yaw = control->yaw;
  }
}

void setMode(bool val) {
  mode = val;
}

PARAM_GROUP_START(ctrlGeom)
PARAM_ADD(PARAM_FLOAT, kr_xy, &kr_xy)
PARAM_ADD(PARAM_FLOAT, kv_xy, &kv_xy)
PARAM_ADD(PARAM_FLOAT, kr_z, &kr_z)
PARAM_ADD(PARAM_FLOAT, kv_z, &kv_z)
PARAM_ADD(PARAM_FLOAT, kR_xy, &kR_xy)
PARAM_ADD(PARAM_FLOAT, kR_z, &kR_z)
PARAM_ADD(PARAM_FLOAT, kw_xy, &kw_xy)
PARAM_ADD(PARAM_FLOAT, kw_z, &kw_z)
PARAM_ADD(PARAM_FLOAT, kd_omega_rp, &kd_omega_rp)
PARAM_ADD(PARAM_FLOAT, timescale, &timescale)
PARAM_ADD(PARAM_UINT8, mode, &mode)
PARAM_ADD(PARAM_UINT8, gp, &gp)
PARAM_ADD(PARAM_FLOAT, mass, &g_vehicleMass)
PARAM_GROUP_STOP(ctrlGeom)

LOG_GROUP_START(ctrlGeom)
LOG_ADD(LOG_FLOAT, cmd_thrust_g, &cmd_thrust_g)
LOG_ADD(LOG_FLOAT, cmd_roll, &cmd_roll)
LOG_ADD(LOG_FLOAT, cmd_pitch, &cmd_pitch)
LOG_ADD(LOG_FLOAT, cmd_yaw, &cmd_yaw)
LOG_ADD(LOG_FLOAT, r_roll, &r_roll)
LOG_ADD(LOG_FLOAT, r_pitch, &r_pitch)
//LOG_ADD(LOG_FLOAT, t, &t)
LOG_ADD(LOG_FLOAT, thrust, &thrust_tmp)
//LOG_ADD(LOG_FLOAT, p_des, &p_des)
//LOG_ADD(LOG_FLOAT, p, &p)
//LOG_ADD(LOG_FLOAT, wdy, &wd.y)
//LOG_ADD(LOG_FLOAT, err_d_pitch, &err_d_pitch)
LOG_ADD(LOG_FLOAT, qw, &q.w)
LOG_ADD(LOG_FLOAT, eRy, &eR.y)
LOG_ADD(LOG_FLOAT, ewy, &ew.y)
LOG_ADD(LOG_FLOAT, psi, &psi)
LOG_ADD(LOG_FLOAT, u1, &u1)
LOG_ADD(LOG_FLOAT, u0, &u0)
// LOG_ADD(LOG_INT16, min0, &min0_i)
// LOG_ADD(LOG_INT16, min1, &min1_i)
// LOG_ADD(LOG_INT16, min2, &min2_i)
// LOG_ADD(LOG_INT16, min3, &min3_i)
// LOG_ADD(LOG_FLOAT, u2, &u2)
LOG_GROUP_STOP(ctrlGeom)

