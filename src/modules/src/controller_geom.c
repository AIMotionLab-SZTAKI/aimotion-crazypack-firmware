/*
The MIT License (MIT)

Copyright (c) 2018 Wolfgang Hoenig and James Alan Preiss

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.
*/

/*
Geometric tracking controller.
*/

#include <math.h>

#include "param.h"
#include "log.h"
#include "math3d.h"
#include "stabilizer.h"
#include "physicalConstants.h"
#include "controller_geom.h"
#include "controller_flip.h"
#include "interpolation.h"


// Inertia matrix components
static float Ixx = 0.000014;
static float Izz = 0.0000217;

static float t = 0;
static float dt = (float)(1.0f/ATTITUDE_RATE);

const static float thrust_scale = 132000; // 119460.0; TODO: find a solution (scale gains somehow)
const static float rollpitch_scale = 7345302.2678;
const static float yaw_scale = 4759362.5498;

static float kr_xy = 0.4;
static float kr_z = 1.25;
static float kv_xy = 0.2;
static float kv_z = 0.4;
static float kR_xy = 0.0095; // 70000/rollpitch_scale;
static float kR_z = 0.0126; // 60000/yaw_scale
static float kw_xy = 0.0027; // 20000/rollpitch_scale;
static float kw_z = 0.0025; // 12000/yaw_scale
static float kd_omega_rp = 0.000027; // 200/rollpitch_scale

// Logging variables

static float cmd_thrust_g;
static float cmd_roll;
static float cmd_pitch;
static float cmd_yaw;
static float r_roll;
static float r_pitch;
static float r_yaw;

static float q0;
static float q2;
static struct quat q;
static float timescale = 1;
static struct vec eR, ew, wd;
static float p_des, p;

static float prev_omega_roll;
static float prev_omega_pitch;
static float prev_setpoint_omega_roll;
static float prev_setpoint_omega_pitch;
static float err_d_roll = 0;
static float err_d_pitch = 0;

static bool mode = false;  // 0: position control, 1: attitude control
static float thrust_tmp;

static float g_vehicleMass = 0.027;

static float psi = 0;

static bool gp = false;
static float u0 = 0;
static float u1 = 0;
static float gr0[5] = {-0.05 , -0.025,  0.   ,  0.025,  0.05};
static float gr1[9] = {-1.  , -0.85, -0.7 , -0.55, -0.4 , -0.25, -0.1 ,  0.05,  0.2};
static float gr2[5] = {-0.2, -0.1,  0. ,  0.1,  0.2};
static float gr3[9] = {-0.2   ,  0.1125,  0.425 ,  0.7375,  1.05  ,  1.3625,  1.675 ,  1.9875,  2.3};
//static int min0_i = 0, min1_i = 0, min2_i = 0, min3_i = 0;

/*static float u2 = 0;
static float sf1 = 0.135f;
static float sf2 = 0.477f;
static float X[48][4] = {{0.000,-0.002,-0.002,-0.003},
{0.000,-0.002,0.013,0.040},
{0.003,-0.012,0.043,0.142},
{0.010,-0.035,0.036,0.171},
{0.014,-0.060,0.009,0.164},
{0.016,-0.085,0.007,0.183},
{0.017,-0.115,0.011,0.251},
{0.018,-0.156,0.008,0.341},
{0.019,-0.211,0.007,0.465},
{0.018,-0.317,-0.058,0.737},
{0.011,-0.428,-0.042,0.937},
{0.009,-0.559,-0.015,1.191},
{0.009,-0.707,-0.023,1.496},
{0.009,-0.854,-0.057,1.852},
{0.012,-0.970,-0.056,2.125},
{0.016,-0.997,-0.013,2.144},
{0.020,-0.925,0.018,1.968},
{0.022,-0.782,0.010,1.680},
{0.025,-0.614,-0.003,1.402},
{0.028,-0.446,-0.009,1.156},
{0.028,-0.298,0.062,0.881},
{0.016,-0.182,0.105,0.581},
{0.009,-0.108,-0.074,0.298},
{0.018,-0.077,0.002,0.038},
{0.000,-0.000,0.000,0.001},
{0.001,-0.002,0.017,0.039},
{0.006,-0.014,0.053,0.134},
{0.016,-0.043,0.029,0.149},
{0.019,-0.065,0.023,0.150},
{0.022,-0.091,0.027,0.203},
{0.026,-0.127,0.025,0.272},
{0.028,-0.172,0.010,0.352},
{0.028,-0.234,0.003,0.490},
{0.024,-0.321,-0.074,0.747},
{0.014,-0.437,-0.050,0.916},
{0.012,-0.568,0.001,1.135},
{0.013,-0.666,-0.007,1.473},
{0.011,-0.865,-0.024,1.818},
{0.010,-0.974,-0.013,2.103},
{0.010,-0.996,0.018,2.150},
{0.007,-0.920,0.018,2.000},
{0.006,-0.829,0.006,1.706},
{0.004,-0.610,-0.005,1.406},
{0.002,-0.446,-0.005,1.185},
{-0.003,-0.295,0.038,0.990},
{-0.007,-0.157,-0.007,0.832},
{-0.009,-0.084,0.058,0.431},
{-0.023,-0.030,0.073,-0.027}};
static float alpha1[48] = {-1248.766,459.255,44.214,-34.284,127.946,-216.751,-2.501,121.021,-55.371,1.990,1.424,-9.429,-8.707,2.210,-1.681,2.783,-3.673,0.432,-1.284,2.732,-2.483,-1.006,4.522,27.951,1387.830,-645.825,17.690,14.348,39.608,-64.078,32.931,-17.654,7.302,3.362,-1.635,4.712,5.039,4.531,-2.717,-2.625,3.136,-2.654,6.305,3.962,-4.778,2.602,-6.563,-2.166};
static float alpha2[48] = {-106.574,176.405,-227.534,330.329,-243.287,289.092,-259.870,220.247,-88.794,17.381,1.528,2.153,5.764,-5.659,6.487,-1.496,-0.003,-0.692,-2.744,0.853,-2.063,-0.351,-4.260,11.433,-73.246,108.075,3.004,-354.976,362.757,-250.661,161.215,-106.161,45.830,-10.685,-5.976,4.136,-2.143,6.399,-21.441,10.587,7.035,-3.006,-1.563,-6.298,3.222,-4.217,7.658,0.271};
static float lam1[4] = {16119.646,11.104,222.851,9.934};
static float lam2[4] = {7222.721,1.805,54.594,13.825};*/

static int ltb1[2025] = {0,3,46,281,822,1098,217,-1482,-2514,0,0,31,247,774,903,-565,-3129,-4402,0,-5,3,154,566,494,-1459,-4710,-6111,-1,-9,-24,39,283,40,-2101,-5595,-6971,-1,-11,-42,-52,37,-282,-2247,-5447,-6647,2,22,185,899,2275,2444,-316,-3123,-3142,0,1,81,611,1764,1611,-1799,-5158,-4922,-3,-28,-77,99,735,207,-3373,-6822,-6330,-6,-54,-227,-432,-401,-1200,-4396,-7434,-6799,-7,-66,-308,-770,-1191,-2054,-4476,-6776,-6160,18,131,644,2058,3726,2675,-1939,-5037,-3799,12,78,375,1250,2178,479,-4506,-7357,-5229,0,-10,-68,-97,-354,-2577,-7061,-9011,-6112,-11,-100,-511,-1452,-2863,-5272,-8571,-9322,-6087,-19,-155,-773,-2268,-4341,-6529,-8445,-8185,-5176,49,218,1152,3028,3788,722,-3878,-5037,-2917,44,143,825,2034,1766,-2129,-6733,-7021,-3835,20,-3,198,266,-1339,-5593,-9287,-8329,-4323,-14,-166,-484,-1575,-4296,-8285,-10513,-8431,-4180,-45,-278,-943,-2747,-5913,-9128,-9928,-7294,-3470,415,-309,-498,601,429,-2396,-4508,-3535,-1508,516,-436,-970,-332,-1241,-4634,-6510,-4691,-1934,497,-626,-1538,-1613,-3300,-6778,-7960,-5346,-2135,356,-818,-1990,-2743,-4930,-7970,-8275,-5234,-2028,164,-914,-2123,-3253,-5473,-7736,-7334,-4403,-1658,1613,-1247,-4545,-4666,-3873,-4030,-3475,-1847,-582,2042,-1415,-5434,-5802,-5196,-5460,-4550,-2356,-731,2057,-1675,-5921,-6448,-6081,-6358,-5123,-2586,-791,1631,-1963,-5852,-6373,-6181,-6363,-4961,-2444,-736,973,-2097,-5187,-5562,-5441,-5473,-4131,-1988,-591,1432,-3614,-7836,-6880,-4522,-2857,-1587,-643,-165,2014,-4118,-8896,-7501,-5001,-3416,-1992,-812,-206,2198,-4421,-9097,-7272,-4884,-3577,-2162,-883,-222,1892,-4442,-8410,-6320,-4235,-3278,-2029,-826,-206,1272,-4079,-7006,-4947,-3270,-2626,-1645,-665,-164,1249,-3884,-6571,-3931,-2078,-1299,-541,-145,-28,2434,-3944,-6904,-3306,-1453,-1182,-591,-176,-35,3503,-3463,-6322,-2117,-524,-879,-564,-185,-38,4035,-2636,-5077,-863,321,-516,-471,-169,-36,3846,-1739,-3598,19,791,-219,-345,-134,-29,2528,179,-1557,-167,202,-212,-160,-36,-4,4218,1241,-917,855,1003,43,-128,-37,-4,5736,2454,73,1979,1807,340,-71,-32,-4,6493,3350,1027,2749,2287,555,-13,-23,-4,6189,3579,1578,2881,2272,613,24,-15,-3,0,7,84,490,1491,2392,1756,-640,-2871,0,2,62,449,1461,2243,881,-2765,-5495,-1,-5,20,307,1150,1660,-369,-5014,-7967,-1,-12,-24,121,685,882,-1487,-6487,-9313,-2,-15,-55,-33,249,213,-2047,-6626,-9015,5,48,362,1687,4402,5855,2984,-1227,-2768,2,18,218,1305,3798,5020,1495,-3505,-4995,-2,-26,-21,531,2252,2979,-666,-5746,-6947,-7,-67,-261,-327,381,555,-2618,-7033,-7839,-9,-89,-405,-926,-1064,-1289,-3605,-6890,-7343,52,272,1242,4022,7934,8260,2577,-2805,-3165,49,211,889,2972,6024,5774,-121,-5211,-4714,35,83,229,954,2251,1308,-3675,-7357,-5829,15,-60,-476,-1230,-1885,-3355,-6648,-8365,-6053,-3,-162,-943,-2702,-4723,-6349,-7865,-7857,-5315,323,822,2481,5997,8741,5961,-451,-3627,-2537,383,846,2183,4823,6338,2691,-3590,-5727,-3486,375,684,1315,2255,1812,-2283,-7135,-7435,-4077,300,396,216,-694,-3042,-6981,-9666,-8058,-4066,192,105,-663,-2831,-6269,-9517,-10175,-7358,-3466,1796,1834,1793,2997,3108,-248,-3519,-3273,-1458,2248,2246,1766,2171,1261,-2760,-5744,-4536,-1911,2334,2204,1201,496,-1557,-5662,-7657,-5367,-2152,2006,1700,295,-1383,-4235,-7797,-8490,-5431,-2083,1417,971,-550,-2687,-5686,-8308,-7912,-4706,-1733,4539,2736,-1603,-3735,-4042,-4395,-3793,-2015,-628,5705,3597,-1714,-4694,-5557,-6032,-4991,-2576,-791,5912,3577,-2067,-5457,-6705,-7133,-5657,-2837,-858,5040,2619,-2593,-5769,-7049,-7259,-5521,-2692,-801,3504,1215,-2971,-5433,-6420,-6355,-4640,-2202,-645,3487,-1945,-7355,-7541,-5798,-3803,-1979,-754,-187,4791,-1910,-8228,-8297,-6595,-4586,-2461,-941,-232,5307,-2143,-8579,-8296,-6704,-4863,-2657,-1013,-248,4803,-2615,-8353,-7604,-6113,-4531,-2488,-941,-228,3565,-2989,-7478,-6380,-4997,-3704,-2019,-753,-181,3215,-3868,-7925,-4802,-2745,-1838,-759,-190,-34,5724,-3271,-8275,-4253,-2227,-1833,-853,-229,-42,7946,-2118,-7602,-3114,-1368,-1586,-843,-240,-45,9013,-869,-6205,-1882,-537,-1202,-735,-219,-41,8536,56,-4539,-956,-7,-813,-565,-174,-33,5991,2675,-810,203,388,-262,-216,-50,-5,9512,5235,497,1526,1317,8,-191,-53,-6,12543,7735,2106,2893,2211,320,-135,-48,-6,13904,9207,3383,3747,2701,544,-72,-38,-5,13051,9074,3842,3780,2618,603,-22,-27,-4,0,9,100,552,1641,2702,2300,-169,-2914,0,4,76,501,1584,2510,1370,-2415,-5739,-1,-4,29,336,1215,1830,-17,-4851,-8405,-1,-12,-23,124,686,943,-1293,-6499,-9857,-2,-16,-59,-51,205,193,-1976,-6738,-9542,8,67,462,2025,5088,6809,4146,-168,-2392,4,36,311,1611,4392,5844,2596,-2455,-4705,0,-13,43,734,2613,3484,175,-4862,-6794,-5,-61,-234,-257,458,682,-2123,-6401,-7814,-9,-89,-410,-965,-1206,-1450,-3415,-6505,-7394,84,375,1596,5030,9793,10514,4738,-1031,-2209,89,325,1249,3957,7791,7892,2039,-3256,-3614,76,191,526,1716,3551,2840,-1911,-5511,-4728,52,24,-286,-804,-1242,-2625,-5519,-6871,-5095,25,-106,-860,-2589,-4662,-6316,-7358,-6822,-4587,630,1430,3395,7473,10960,8399,1621,-2143,-1755,770,1600,3247,6390,8589,5134,-1438,-4066,-2558,792,1486,2369,3632,3656,-315,-5295,-5852,-3126,686,1127,1103,285,-1882,-5784,-8406,-6778,-3227,498,675,-33,-2295,-5795,-9072,-9527,-6482,-2826,3251,4506,4528,4695,4018,388,-2936,-2776,-1182,4073,5611,5198,4242,2301,-2052,-5081,-3953,-1578,4293,5827,4877,2635,-575,-5021,-7029,
-4786,-1808,3806,5035,3655,486,-3482,-7340,-8001,-4938,-1777,2831,3597,2069,-1309,-5234,-8072,-7606,-4352,-1500,7154,7864,3665,-1220,-3871,-4768,-3967,-2009,-592,8979,9982,4799,-1639,-5329,-6376,-5107,-2531,-739,9402,10347,4773,-2340,-6498,-7403,-5687,-2755,-797,8213,8729,3504,-3112,-6940,-7447,-5475,-2589,-740,5963,5908,1634,-3556,-6441,-6478,-4555,-2100,-594,4942,1203,-3661,-5675,-5863,-4218,-2127,-769,-183,6826,2050,-3908,-6431,-6996,-5173,-2616,-941,-223,7705,2058,-4370,-6884,-7531,-5591,-2801,-994,-234,7200,1146,-4972,-6941,-7299,-5321,-2609,-909,-212,5611,-145,-5282,-6445,-6328,-4447,-2113,-718,-165,4920,-2306,-6741,-4176,-2790,-2050,-842,-202,-33,8600,-800,-6882,-3944,-2697,-2270,-989,-243,-41,11887,1094,-6247,-3340,-2342,-2248,-1026,-256,-43,13500,2629,-5128,-2659,-1900,-2005,-940,-235,-39,12833,3279,-3857,-2074,-1491,-1614,-760,-189,-31,9246,5774,905,841,539,-260,-227,-53,-6,14377,9820,2862,2174,1315,-80,-227,-59,-7,18703,13484,4900,3424,2001,126,-198,-58,-7,20538,15344,6215,4080,2310,274,-152,-50,-6,19143,14665,6308,3911,2143,312,-104,-38,-5,0,8,78,387,1029,1474,937,-944,-2967,0,4,56,324,888,1106,-83,-2975,-5381,0,-2,16,178,541,456,-1316,-5008,-7543,-1,-9,-26,6,128,-207,-2255,-6221,-8593,-1,-13,-55,-121,-185,-629,-2552,-6166,-8138,8,62,393,1554,3438,3778,1242,-1623,-2807,5,38,270,1172,2638,2465,-618,-3872,-4887,1,-1,48,424,1057,284,-2849,-5963,-6627,-2,-41,-183,-391,-671,-1881,-4533,-7035,-7317,-5,-66,-332,-947,-1857,-3176,-5029,-6704,-6719,89,354,1394,4108,7257,6539,1580,-1942,-2030,99,327,1131,3212,5370,3771,-1290,-4054,-3218,91,223,548,1359,1760,-679,-4833,-6010,-4120,69,83,-125,-715,-2137,-5032,-7616,-7007,-4364,42,-35,-617,-2177,-4755,-7546,-8543,-6673,-3872,728,1551,3099,5995,7953,4976,-345,-2322,-1358,900,1800,3095,5155,5863,1899,-3261,-4044,-1990,943,1760,2449,2968,1841,-2672,-6574,-5565,-2440,839,1440,1408,295,-2520,-6921,-8957,-6269,-2521,631,976,400,-1780,-5461,-9136,-9458,-5883,-2209,3622,5574,5447,4009,1693,-1957,-3955,-2761,-978,4542,6974,6498,3852,208,-4183,-5906,-3788,-1295,4818,7351,6466,2732,-1956,-6463,-7440,-4454,-1474,4324,6525,5330,1068,-3955,-7896,-7946,-4491,-1440,3280,4866,3587,-440,-4966,-7896,-7219,-3885,-1210,7336,9999,6949,601,-3948,-5359,-4214,-1977,-534,9211,12585,8760,587,-5212,-6780,-5201,-2421,-655,9706,13159,8961,45,-6136,-7487,-5566,-2563,-693,8586,11415,7383,-875,-6383,-7208,-5165,-2347,-633,6366,8169,4777,-1727,-5818,-6043,-4155,-1858,-500,4593,3240,161,-3018,-4941,-3958,-2006,-711,-164,6470,4517,416,-3755,-6254,-4932,-2434,-847,-195,7482,4748,-85,-4620,-7140,-5416,-2573,-873,-200,7207,3775,-1245,-5357,-7294,-5233,-2370,-779,-176,5833,2137,-2434,-5555,-6598,-4438,-1903,-601,-134,5164,-286,-3884,-2615,-2319,-1857,-754,-175,-28,9031,1745,-3735,-2746,-2704,-2273,-927,-213,-34,12537,3938,-3232,-2795,-2948,-2495,-1006,-226,-35,14318,5428,-2615,-2798,-2990,-2448,-963,-210,-31,13689,5692,-2030,-2671,-2767,-2133,-811,-170,-24,9962,7310,2446,1324,527,-231,-193,-44,-5,15320,11773,4592,2386,975,-187,-220,-53,-5,19782,15644,6573,3252,1305,-132,-225,-55,-6,21610,17415,7606,3565,1372,-92,-206,-51,-5,20065,16383,7301,3225,1168,-76,-170,-42,-4,0,4,36,136,185,-171,-977,-2058,-2816,0,2,20,71,-15,-669,-1979,-3629,-4482,0,-2,-5,-29,-274,-1171,-2860,-4950,-5814,0,-6,-30,-125,-484,-1469,-3256,-5482,-6280,0,-8,-45,-177,-565,-1452,-3029,-5041,-5713,5,39,217,688,923,-402,-2702,-3714,-3263,4,25,137,387,128,-1897,-4696,-5723,-4867,2,1,0,-95,-960,-3501,-6368,-7193,-6002,0,-23,-138,-568,-1906,-4561,-7030,-7515,-6203,-2,-38,-223,-842,-2334,-4665,-6443,-6594,-5416,64,231,817,2088,2679,259,-3289,-3839,-2251,73,221,658,1458,1113,-2358,-6097,-5757,-3190,70,162,310,312,-1231,-5424,-8652,-7155,-3785,57,78,-88,-895,-3420,-7707,-9916,-7459,-3791,38,2,-379,-1677,-4574,-8299,-9400,-6567,-3218,557,1128,1895,2902,2556,-725,-3738,-3229,-1297,693,1338,1936,2315,901,-3361,-6303,-4695,-1781,734,1344,1590,1036,-1560,-6311,-8557,-5753,-2077,661,1141,988,-432,-3851,-8400,-9593,-5973,-2063,506,813,378,-1494,-5046,-8786,-9001,-5274,-1749,2707,4377,4055,1760,-1560,-4730,-5080,-2811,-843,3395,5489,4934,1673,-2758,-6582,-6702,-3641,-1083,3613,5824,5041,1118,-3937,-7884,-7638,-4070,-1197,3264,5230,4309,296,-4641,-8123,-7514,-3925,-1141,2501,3969,3058,-441,-4572,-7194,-6376,-3264,-936,5131,7858,6134,692,-3819,-5260,-3985,-1768,-447,6453,9847,7631,729,-4789,-6352,-4747,-2109,-537,6831,10322,7818,358,-5340,-6683,-4895,-2174,-557,6093,9044,6558,-321,-5278,-6129,-4371,-1936,-499,4576,6598,4435,-986,-4601,-4901,-3381,-1489,-385,2910,2968,1558,-1351,-3554,-3057,-1591,-570,-130,4238,4030,1856,-2045,-4726,-3839,-1901,-664,-152,5057,4302,1403,-2989,-5620,-4242,-1977,-668,-152,5033,3633,310,-3872,-5918,-4119,-1791,-580,-131,4222,2387,-879,-4265,-5465,-3507,-1415,-435,-97,3907,863,-1371,-1249,-1650,-1370,-541,-124,-20,6859,2661,-1095,-1574,-2242,-1810,-690,-151,-23,9570,4467,-776,-1978,-2775,-2120,-775,-161,-24,10988,5568,-566,-2339,-3064,-2189,-764,-150,-21,10558,5569,-489,-2461,-2965,-1978,-659,-122,-16,7699,6248,2719,1279,353,-189,-135,-29,-3,11751,9768,4437,1942,507,-236,-172,-37,-3,15098,12732,5888,2393,563,-279,-195,-41,-4,16432,13983,6499,2443,486,-305,-195,-40,-4,15214,13022,6038,2088,319,-299,-173,-34,-3};

static int ltb0[2025] = {4,16,40,68,76,58,31,11,3,18,69,186,355,479,470,342,187,75,18,54,113,123,-7,-181,-198,-78,10,1,0,-14,-62,-136,-181,-149,-74,-20,0,0,0,0,0,-1,0,0,0,6,22,57,94,106,81,42,15,4,25,95,255,480,638,614,436,232,92,25,78,169,207,58,-179,-239,-111,-1,2,1,-15,-72,-164,-224,-188,-96,-28,0,0,0,0,-1,-1,-1,0,0,8,30,75,124,139,106,55,20,5,32,123,328,613,805,759,527,273,106,34,105,234,312,156,-145,-262,-142,-15,3,3,-14,-78,-185,-258,-222,-117,-36,0,0,0,0,-1,-1,-1,0,0,10,37,93,154,173,131,67,24,6,40,151,400,740,960,890,604,305,115,43,132,301,428,281,-76,-259,-164,-30,5,6,-11,-78,-196,-280,-245,-132,-42,0,0,0,0,-1,-1,-1,0,0,11,43,109,181,202,152,78,27,7,47,174,459,843,1083,988,655,323,119,52,156,361,541,419,22,-228,-172,-42,6,9,-6,-72,-193,-284,-254,-140,-46,0,0,0,0,-1,-2,-1,0,0,13,48,120,199,222,167,85,30,7,51,190,498,908,1155,1038,674,324,117,59,174,405,632,546,135,-172,-164,-49,8,12,0,-61,-178,-270,-247,-139,-48,0,0,0,0,-1,-1,-1,0,0,13,50,125,207,231,173,88,30,7,53,196,509,922,1163,1032,658,308,108,62,181,426,685,643,243,-101,-141,-51,9,14,5,-47,-152,-240,-225,-129,-45,0,0,0,0,-1,-1,-1,0,0,13,49,122,203,226,169,86,29,7,52,190,491,885,1107,971,608,278,95,63,178,420,693,691,327,-28,-109,-46,9,15,10,-31,-121,-200,-192,-113,-41,0,0,0,0,-1,-1,-1,0,0,12,45,113,188,209,156,79,27,6,48,174,447,801,996,864,532,238,79,59,165,388,653,684,374,33,-74,-38,9,16,14,-17,-89,-156,-154,-92,-34,0,0,0,0,0,-1,-1,0,0,16,74,196,333,377,285,145,50,12,-141,-159,-149,3,280,471,460,323,170,32,-203,-873,-1449,-1280,-425,487,905,785,8,-124,-368,-529,-451,-196,91,298,346,0,-3,-7,-9,-9,-9,-11,-12,-11,23,104,273,465,527,398,202,69,16,-211,-241,-241,-48,324,579,559,379,193,70,-254,-1220,-2073,-1892,-796,355,895,797,22,-165,-519,-756,-653,-318,35,274,333,0,-4,-10,-13,-12,-11,-12,-12,-11,29,136,358,612,694,524,265,90,21,-297,-341,-362,-133,342,671,644,424,209,129,-289,-1605,-2790,-2607,-1254,148,817,762,45,-206,-690,-1019,-888,-461,-37,230,301,0,-5,-13,-18,-16,-13,-12,-12,-10,35,168,444,759,861,650,329,112,26,-394,-454,-504,-251,324,732,705,451,215,211,-295,-1987,-3536,-3362,-1756,-115,682,684,77,-239,-865,-1296,-1137,-613,-120,172,254,-1,-7,-17,-22,-20,-14,-12,-10,-9,40,195,518,888,1006,761,385,131,30,-491,-568,-655,-395,265,750,732,456,210,311,-263,-2313,-4222,-4068,-2240,-398,508,576,116,-258,-1022,-1554,-1369,-755,-201,110,200,0,-8,-20,-27,-23,-15,-11,-9,-7,43,214,570,978,1110,839,424,144,33,-578,-668,-795,-547,170,719,719,439,195,421,-187,-2532,-4750,-4627,-2638,-660,322,452,160,-257,-1137,-1758,-1555,-867,-269,51,146,0,-9,-23,-30,-26,-16,-10,-7,-5,44,220,591,1016,1153,872,441,149,34,-640,-738,-902,-686,51,643,668,402,172,528,-75,-2605,-5037,-4953,-2890,-862,149,330,202,-237,-1192,-1877,-1666,-935,-315,2,98,0,-9,-24,-33,-27,-16,-9,-6,-4,41,214,578,994,1130,855,432,146,33,-668,-767,-960,-788,-71,534,587,349,145,613,56,-2517,-5034,-4994,-2958,-977,9,221,237,-198,-1176,-1889,-1683,-947,-335,-32,60,0,-9,-24,-33,-27,-16,-8,-4,-3,36,196,532,918,1044,790,399,135,30,-657,-749,-957,-836,-179,407,486,288,116,664,187,-2284,-4742,-4745,-2838,-1000,-85,133,258,-147,-1093,-1794,-1605,-902,-327,-52,32,0,-8,-23,-31,-26,-14,-6,-3,-2,23,33,35,31,35,62,108,137,119,219,346,458,396,268,432,802,843,456,-1527,-1683,-1097,-584,-493,-296,165,312,16,-1078,-1395,-1221,-844,-769,-1022,-1113,-799,-343,-29,-44,-53,-75,-138,-229,-283,-249,-153,33,47,49,41,40,64,108,137,119,361,535,669,566,340,432,799,865,488,-1863,-2030,-1242,-586,-541,-421,62,289,37,-1454,-1891,-1649,-1101,-903,-1127,-1216,-877,-387,-40,-62,-70,-89,-151,-244,-298,-260,-159,44,62,63,51,44,63,103,129,112,551,777,924,765,425,414,746,834,488,-2085,-2239,-1250,-477,-517,-519,-55,239,51,-1841,-2409,-2099,-1362,-1011,-1174,-1252,-906,-409,-53,-80,-89,-101,-156,-245,-296,-256,-156,55,77,78,60,47,59,92,114,99,781,1061,1204,977,516,386,655,754,457,-2113,-2223,-1069,-238,-404,-566,-167,170,55,-2188,-2887,-2514,-1596,-1081,-1158,-1216,-881,-405,-65,-99,-107,-110,-154,-233,-277,-238,-144,66,91,90,67,48,53,78,96,83,1033,1362,1482,1176,603,352,540,639,
402,-1895,-1929,-678,126,-205,-549,-253,95,50,-2438,-3251,-2835,-1768,-1104,-1082,-1113,-807,-375,-75,-115,-122,-115,-145,-209,-245,-209,-125,73,101,99,72,47,45,62,76,65,1275,1642,1722,1335,673,319,420,509,331,-1430,-1360,-106,577,54,-469,-298,28,39,-2547,-3438,-3008,-1851,-1074,-959,-962,-697,-327,-81,-126,-132,-116,-131,-178,-204,-172,-103,77,106,102,73,44,37,47,56,48,1472,1861,1888,1431,714,287,308,380,256,-773,-589,571,1049,333,-344,-301,-21,25,-2489,-3412,-3001,-1828,-996,-807,-784,-567,-268,-83,-130,-135,-112,-112,-143,-161,-135,-80,77,105,100,70,40,29,34,39,34,1592,1982,1953,1447,716,256,215,266,185,-31,261,1245,1464,583,-200,-268,-51,12,-2273,-3176,-2815,-1703,-880,-645,-603,-434,-206,-80,-127,-131,-103,-92,-109,-120,-99,-58,72,98,93,63,34,22,23,26,22,1614,1985,1906,1380,678,225,144,174,126,668,1045,1800,1753,764,-64,-214,-62,2,-1935,-2770,-2479,-1495,-738,-490,-438,-314,-150,-72,-117,-120,-91,-73,-79,-84,-69,-40,2,2,0,-3,-3,2,9,10,7,63,131,234,402,678,909,780,308,-95,134,454,1115,1588,1240,191,-902,-1606,-1745,-194,-372,-444,-530,-834,-1171,-1139,-759,-390,-20,-34,-40,-33,-20,-12,-9,-5,-2,3,3,0,-4,-6,0,8,11,7,89,182,312,501,802,1067,942,423,-40,188,622,1545,2251,1894,653,-632,-1442,-1638,-278,-535,-617,-659,-951,-1311,-1268,-830,-408,-29,-50,-58,-47,-28,-15,-10,-6,-2,4,5,1,-5,-8,-2,7,10,7,118,239,396,595,899,1177,1062,524,21,248,801,2014,2982,2630,1204,-262,-1172,-1431,-376,-728,-817,-787,-1030,-1385,-1334,-861,-406,-40,-68,-80,-64,-37,-18,-10,-6,-2,5,6,2,-6,-10,-4,5,9,6,148,297,479,676,955,1222,1120,592,80,310,971,2469,3702,3364,1775,155,-836,-1159,-479,-935,-1028,-904,-1060,-1382,-1324,-845,-384,-52,-88,-103,-82,-47,-21,-11,-5,-2,6,8,3,-6,-12,-7,2,7,5,175,348,550,733,964,1196,1106,616,125,364,1107,2849,4318,3998,2283,557,-488,-862,-575,-1134,-1230,-997,-1039,-1303,-1241,-785,-345,-63,-107,-125,-100,-56,-24,-10,-5,-2,7,9,4,-6,-13,-9,0,5,4,194,385,599,760,927,1104,1024,595,151,405,1188,3095,4736,4436,2652,883,-175,-582,-652,-1299,-1395,-1056,-971,-1160,-1097,-690,-295,-72,-123,-143,-115,-64,-26,-10,-4,-1,8,10,5,-5,-13,-10,-1,3,3,204,402,619,753,850,962,889,534,157,425,1199,3165,4889,4613,2830,1090,64,-346,-696,-1404,-1498,-1071,-867,-976,-916,-573,-239,-78,-133,-154,-124,-68,-27,-9,-3,-1,7,10,6,-4,-12,-10,-3,2,2,202,396,605,711,746,794,725,447,146,422,1138,3049,4754,4505,2799,1164,217,-171,-700,-1431,-1523,-1040,-742,-777,-722,-450,-184,-79,-135,-157,-126,-70,-26,-8,-2,-1,7,9,6,-2,-10,-9,-3,0,1,188,368,559,640,626,621,557,349,123,395,1016,2764,4356,4139,2584,1119,287,-57,-664,-1377,-1465,-964,-608,-585,-537,-333,-134,-76,-130,-150,-121,-67,-25,-7,-2,0,0,0,-2,-6,-9,-9,-5,-2,0,-1,-8,-29,-56,-57,-6,52,65,40,-15,-59,-142,-199,-135,15,117,122,82,-4,-26,-93,-207,-308,-318,-229,-111,-32,0,2,4,4,2,-1,-2,-1,0,0,0,-3,-7,-11,-11,-7,-3,0,-2,-10,-36,-74,-82,-26,46,68,44,-20,-80,-194,-281,-209,-9,131,143,93,-5,-33,-117,-262,-388,-393,-279,-135,-40,0,3,5,6,3,0,-2,-1,0,0,-1,-3,-8,-14,-14,-9,-3,0,-2,-12,-44,-92,-108,-50,34,66,45,-26,-101,-249,-371,-296,-51,133,156,101,-6,-39,-140,-314,-461,-462,-321,-154,-46,1,3,7,8,5,0,-2,-1,0,0,-1,-4,-9,-15,-16,-10,-4,-1,-2,-14,-49,-106,-132,-74,18,59,43,-30,-120,-300,-458,-388,-105,120,159,102,-7,-44,-158,-354,-519,-514,-352,-166,-50,1,4,9,11,7,0,-2,-1,0,0,-1,-4,-10,-16,-16,-11,-4,-1,-2,-14,-51,-114,-148,-96,0,48,38,-34,-134,-339,-530,-472,-166,94,151,98,-7,-45,-167,-377,-552,-541,-365,-170,-51,1,5,11,13,9,2,-1,-1,0,0,-1,-4,-10,-16,-16,-11,-4,-1,-2,-14,-51,-115,-155,-111,-18,35,32,-35,-141,-361,-575,-535,-223,59,134,89,-6,-44,-166,-379,-554,-540,-359,-164,-50,1,6,12,15,11,3,-1,-1,0,0,0,-3,-9,-14,-15,-10,-4,-1,-2,-12,-47,-108,-151,-117,-32,22,25,-34,-139,-361,-586,-565,-267,20,109,75,-5,-40,-155,-358,-525,-509,-334,-151,-45,2,6,12,16,12,4,0,-1,0,0,0,-3,-8,-13,-13,-9,-4,-1,-1,-10,-40,-96,-137,-113,-40,10,17,-32,-130,-339,-559,-556,-288,-14,81,60,-4,-34,-136,-319,-470,-454,-295,-131,-39,1,6,12,16,12,4,0,-1,0,0,0,-2,-6,-10,-11,-7,-3,-1,-1,-8,-33,-79,-117,-101,-42,2,11,-28,-114,-300,-501,-513,-286,-40,54,45,-3,-27,-113,-268,-397,-382,-246,-108,-32,1,5,11,15,12,5,0,0,0};

static float u0_max = 0, u1_max = 0, u0_min = 0, u1_min = 0;

void controllerGeomReset(void)
{
  t = 0;
}

void controllerGeomInit(void)
{
  controllerGeomReset();
  for(int i = 0; i < 2025; i++){
    if((float)ltb0[i]/10000.0f > u0_max) u0_max = (float)ltb0[i]/10000.0f;
    if((float)ltb1[i]/10000.0f > u1_max) u1_max = (float)ltb1[i]/10000.0f;
    if((float)ltb0[i]/10000.0f < u0_min) u0_min = (float)ltb0[i]/10000.0f;
    if((float)ltb1[i]/10000.0f < u0_min) u1_min = (float)ltb1[i]/10000.0f;
  }
}

bool controllerGeomTest(void)
{
  return true;
}

void controllerGeom(control_t *control, setpoint_t *setpoint,
                                         const sensorData_t *sensors,
                                         const state_t *state,
                                         const uint32_t tick)
{
  if (!RATE_DO_EXECUTE(ATTITUDE_RATE, tick)) {
      return;
    }

  struct vec er, ev, r1, r2, r3, M;
  struct mat33 Rd;
  float yaw_des = radians(setpoint->attitude.yaw);
  struct vec setpointPos = mkvec(setpoint->position.x, setpoint->position.y, setpoint->position.z);
  struct vec setpointVel = mkvec(setpoint->velocity.x, setpoint->velocity.y, setpoint->velocity.z);
  struct vec statePos = mkvec(state->position.x, state->position.y, state->position.z);
  struct vec stateVel = mkvec(state->velocity.x, state->velocity.y, state->velocity.z);
  float T;

  // Position Error (ep)
  er = vsub(statePos, setpointPos);

  // Velocity Error (ev)
  ev = vsub(stateVel, setpointVel);

  struct vec target_thrust = vzero();

  /* if (setpoint->mode.x == modeAbs) {
    target_thrust.x = -kr_xy*er.x - kv_xy*ev.x + g_vehicleMass*setpoint->acceleration.x;
    target_thrust.y = -kr_xy*er.y - kv_xy*ev.y + g_vehicleMass*setpoint->acceleration.y;
    target_thrust.z = -kr_z*er.z - kv_z*ev.z + g_vehicleMass*(setpoint->acceleration.x + GRAVITY_MAGNITUDE);
  } else {
    target_thrust.x = -sinf(radians(setpoint->attitude.pitch));
    target_thrust.y = -sinf(radians(setpoint->attitude.roll));
    if (setpoint->mode.z == modeAbs) {
      target_thrust.z = -kr_z*er.z - kv_z*ev.z + g_vehicleMass*GRAVITY_MAGNITUDE;
    } else {
      target_thrust.z = 1;
    }
  }*/
  
  if (!mode) {      // position control
    target_thrust.x = -kr_xy*er.x - kv_xy*ev.x + g_vehicleMass*setpoint->acceleration.x;
    target_thrust.y = -kr_xy*er.y - kv_xy*ev.y + g_vehicleMass*setpoint->acceleration.y;
    target_thrust.z = -kr_z*er.z - kv_z*ev.z + g_vehicleMass*(setpoint->acceleration.z + GRAVITY_MAGNITUDE);
    r3 = vnormalize(target_thrust);
    r2 = vnormalize(vcross(r3,mkvec(cosf(yaw_des), sinf(yaw_des), 0)));
    r1 = vcross(r2, r3);
    Rd = mcolumns(r1, r2, r3);
    wd = mkvec(radians(setpoint->attitudeRate.roll), -radians(setpoint->attitudeRate.pitch), radians(setpoint->attitudeRate.yaw));
  } else {
    target_thrust.z = -kr_z*er.z - kv_z*ev.z + g_vehicleMass*(setpoint->acceleration.z + GRAVITY_MAGNITUDE);
    t = getTime();
    T = t/timescale;
    // flip trajectory
    q0 = 1.998f/(1.0f+expf(-20.0f*(T-0.45f)))-0.999f;
    q2 = sqrtf(1.0f-q0*q0);
    float dq0 = -(39.9f * expf(-20.0f * (T - 0.45f))) / ( (expf(-20.0f * (T - 0.45f)) + 1.0f) * (expf(-20.0f * (T - 0.45f)) + 1.0f) );
    struct quat qd = mkquat(0, q2, 0, q0);
    struct vec eul_des = quat2rpy(qd);
    p_des = eul_des.y;
    Rd = quat2rotmat(qd);
    wd = mkvec(0.0f, -2.0f*dq0/sqrtf(1.0f-q0*q0), 0.0f);
  }
  q = mkquat(state->attitudeQuaternion.x, state->attitudeQuaternion.y, state->attitudeQuaternion.z, state->attitudeQuaternion.w);
  struct vec eul = quat2rpy(q);
  p = eul.y;
  struct mat33 R = quat2rotmat(q);

  struct mat33 eR1 = mmul(mtranspose(Rd),R);
  struct mat33 eR2 = mmul(mtranspose(R),Rd);
  struct mat33 tr_tmp = msub(meye(),eR1);
  psi = 0.5f*(tr_tmp.m[0][0] + tr_tmp.m[1][1] + tr_tmp.m[2][2]);

  struct mat33 eRm = msub(eR1,eR2);

  eR.x = 1.0f*eRm.m[2][1];
  eR.y = -1.0f*eRm.m[0][2];
  eR.z = 1.0f*eRm.m[1][0];

  float stateAttitudeRateRoll = radians(sensors->gyro.x);
  float stateAttitudeRatePitch = -radians(sensors->gyro.y);
  float stateAttitudeRateYaw = radians(sensors->gyro.z);

  struct vec w = mkvec(stateAttitudeRateRoll, stateAttitudeRatePitch, stateAttitudeRateYaw);

  // struct vec w_target = mvmul(eR2,wd);

  ew = vsub(w,wd);


  if (prev_omega_roll == prev_omega_roll) { /*d part initialized*/
    if (!mode){
      err_d_roll = ((radians(setpoint->attitudeRate.roll) - prev_setpoint_omega_roll) - (stateAttitudeRateRoll - prev_omega_roll)) / dt;
      err_d_pitch = (-(radians(setpoint->attitudeRate.pitch) - prev_setpoint_omega_pitch) - (stateAttitudeRatePitch - prev_omega_pitch)) / dt;
      prev_omega_roll = stateAttitudeRateRoll;
      prev_omega_pitch = stateAttitudeRatePitch;
      prev_setpoint_omega_roll = radians(setpoint->attitudeRate.roll);
      prev_setpoint_omega_pitch = radians(setpoint->attitudeRate.pitch);
    } else {
      err_d_roll = clamp(((wd.x - prev_setpoint_omega_roll) - (stateAttitudeRateRoll - prev_omega_roll)) / dt, -200, 200);
      err_d_pitch = clamp(((wd.y - prev_setpoint_omega_pitch) - (stateAttitudeRatePitch - prev_omega_pitch)) / dt, -200, 200);
      prev_omega_roll = stateAttitudeRateRoll;
      prev_omega_pitch = stateAttitudeRatePitch;
      prev_setpoint_omega_roll = wd.x;
      prev_setpoint_omega_pitch = wd.y;
    }
  }
  

  struct vec cross = vcross(w, mkvec(Ixx*w.x, Ixx*w.x, Izz*w.z));
  // cross = vzero();

  float thrust = 0;
  if (!mode){
    M.x = cross.x - kR_xy * eR.x - kw_xy * ew.x + kd_omega_rp * err_d_roll;
    M.y = cross.y - kR_xy * eR.y - kw_xy * ew.y + kd_omega_rp * err_d_pitch;
    M.z = -kR_z  * eR.z - kw_z  * ew.z;
    thrust = vdot(target_thrust, mcolumn(R,2));
  } else {
    /*float xtilde[4] = {q.x, q.y, w.x / 10.0f, w.y / 10.0f};
    float utmp = 0;

    float tmp1 = 0;
    float k1[48];
    for (int i = 0; i < 48; i++) {
      for (int j = 0; j < 4; j++) {
        tmp1 += -0.5f * lam1[j] * powf((xtilde[j] - X[i][j]), 2.0f);
      }
      k1[i] += sf1 * expf(tmp1);
    }
    for (int i = 0; i < 48; i++) {
      utmp += k1[i] * alpha1[i];
    }
    u1 = utmp / 200.0f;
    utmp = 0.0f;

    float tmp2 = 0;
    float k2[48];
    for (int i = 0; i < 48; i++) {
      for (int j = 0; j < 4; j++) {
        tmp2 += -0.5f * lam2[j] * powf((xtilde[j] - X[i][j]), 2.0f);
      }
      k2[i] += sf2 * expf(tmp2);
    }
    for (int i = 0; i < 48; i++) {
      utmp += k2[i] * alpha2[i];
    }
    u2 = utmp / 200.0f;
    */
    if(gp){
      float xtilde[4] = {q.x, q.y, w.x / 10.0f, w.y / 10.0f};
      /*float min0 = 10;
      float min1 = 10;
      float min2 = 10;
      float min3 = 10;
      min0_i = 0; min1_i = 0; min2_i = 0; min3_i = 0;
      for(int i=0; i < 5; i++){
        float diff = fabsf(gr0[i] - xtilde[0]);
        if(diff < min0) {
          min0 = diff;
          min0_i = i;
        }
      }
      for(int i=0; i < 9; i++){
        float diff = fabsf(gr1[i] - xtilde[1]);
        if(diff < min1) {
          min1 = diff;
          min1_i = i;
        }
      }
      for(int i=0; i < 5; i++){
        float diff = fabsf(gr2[i] - xtilde[2]);
        if(diff < min2) {
          min2 = diff;
          min2_i = i;
        }
      }
      for(int i=0; i < 9; i++){
        float diff = fabsf(gr3[i] - xtilde[3]);
        if(diff < min3) {
          min3 = diff;
          min3_i = i;
        }
      }
      u1 = (float)ltb1[min0_i*min1_i*min2_i*min3_i] / 10000.0f / 200.0f / 10.0f;
      u0 = (float)ltb0[min0_i*min1_i*min2_i*min3_i] / 10000.0f / 200.0f / 10.0f;
      */
      u0 = LI_4D(5, 9, 5, 9, gr0, gr1, gr2, gr3, ltb0, xtilde[0], xtilde[1], xtilde[2], xtilde[3]);
      u0 = clamp(u0, u0_min, u0_max) / 200.0f / 10.0f;
      u1 = LI_4D(5, 9, 5, 9, gr0, gr1, gr2, gr3, ltb1, xtilde[0], xtilde[1], xtilde[2], xtilde[3]);
      u1 = clamp(u1, u1_min, u1_max) / 200.0f / 10.0f;
    }
    
    M.x = cross.x - kR_xy * eR.x - kw_xy * ew.x + kd_omega_rp * err_d_roll - u0;
    M.y = cross.y - kR_xy * eR.y - kw_xy * ew.y + kd_omega_rp * err_d_pitch - u1;
    M.z = kR_z  * eR.z - kw_z  * ew.z;
    float den = R.m[2][2];
    if(den > 1e-7f){
      thrust_tmp = clamp(target_thrust.z / den, 0.22f, 0.5f);
    } else{
      thrust_tmp = 0.22f;
    }
    //thrust = (0.22f * cosf(2.0f * 3.14f * t / (0.9f*timescale)) + 0.4f);
    thrust = thrust_tmp;
  }
  
 
  if (setpoint->mode.z == modeDisable) {
    control->thrust = setpoint->thrust;
  } else {
    control->thrust = thrust * thrust_scale;
  }
  cmd_thrust_g = thrust*thrust_scale;
  r_roll = radians(sensors->gyro.x);
  r_pitch = -radians(sensors->gyro.y);
  r_yaw = radians(sensors->gyro.z);

  if (control->thrust > 0) {
    control->roll = clamp(M.x * rollpitch_scale, -32000, 32000);
    control->pitch = clamp(M.y * rollpitch_scale, -32000, 32000);
    control->yaw = clamp(-M.z * yaw_scale, -32000, 32000);
    cmd_roll = control->roll;
    cmd_pitch = control->pitch;
    cmd_yaw = control->yaw;
  } else {
    control->roll = 0;
    control->pitch = 0;
    control->yaw = 0;

    cmd_roll = control->roll;
    cmd_pitch = control->pitch;
    cmd_yaw = control->yaw;
  }
}

void setMode(bool val) {
  mode = val;
}

PARAM_GROUP_START(ctrlGeom)
PARAM_ADD(PARAM_FLOAT, kr_xy, &kr_xy)
PARAM_ADD(PARAM_FLOAT, kv_xy, &kv_xy)
PARAM_ADD(PARAM_FLOAT, kr_z, &kr_z)
PARAM_ADD(PARAM_FLOAT, kv_z, &kv_z)
PARAM_ADD(PARAM_FLOAT, kR_xy, &kR_xy)
PARAM_ADD(PARAM_FLOAT, kR_z, &kR_z)
PARAM_ADD(PARAM_FLOAT, kw_xy, &kw_xy)
PARAM_ADD(PARAM_FLOAT, kw_z, &kw_z)
PARAM_ADD(PARAM_FLOAT, kd_omega_rp, &kd_omega_rp)
PARAM_ADD(PARAM_FLOAT, timescale, &timescale)
PARAM_ADD(PARAM_UINT8, mode, &mode)
PARAM_ADD(PARAM_UINT8, gp, &gp)
PARAM_ADD(PARAM_FLOAT, mass, &g_vehicleMass)
PARAM_GROUP_STOP(ctrlGeom)

LOG_GROUP_START(ctrlGeom)
LOG_ADD(LOG_FLOAT, cmd_thrust_g, &cmd_thrust_g)
LOG_ADD(LOG_FLOAT, cmd_roll, &cmd_roll)
LOG_ADD(LOG_FLOAT, cmd_pitch, &cmd_pitch)
LOG_ADD(LOG_FLOAT, cmd_yaw, &cmd_yaw)
LOG_ADD(LOG_FLOAT, r_roll, &r_roll)
LOG_ADD(LOG_FLOAT, r_pitch, &r_pitch)
//LOG_ADD(LOG_FLOAT, t, &t)
LOG_ADD(LOG_FLOAT, thrust, &thrust_tmp)
//LOG_ADD(LOG_FLOAT, p_des, &p_des)
//LOG_ADD(LOG_FLOAT, p, &p)
//LOG_ADD(LOG_FLOAT, wdy, &wd.y)
//LOG_ADD(LOG_FLOAT, err_d_pitch, &err_d_pitch)
LOG_ADD(LOG_FLOAT, qw, &q.w)
LOG_ADD(LOG_FLOAT, eRy, &eR.y)
LOG_ADD(LOG_FLOAT, ewy, &ew.y)
LOG_ADD(LOG_FLOAT, psi, &psi)
LOG_ADD(LOG_FLOAT, u1, &u1)
LOG_ADD(LOG_FLOAT, u0, &u0)
// LOG_ADD(LOG_INT16, min0, &min0_i)
// LOG_ADD(LOG_INT16, min1, &min1_i)
// LOG_ADD(LOG_INT16, min2, &min2_i)
// LOG_ADD(LOG_INT16, min3, &min3_i)
// LOG_ADD(LOG_FLOAT, u2, &u2)
LOG_GROUP_STOP(ctrlGeom)

